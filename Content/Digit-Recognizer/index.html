<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="data.js"></script>
    <title>Digit Recognizer</title>
</head>
<body>
    <canvas id="myCanvas" width="200" height="200" style="border:1px solid #000000;"></canvas>
    <canvas id="image" width="200" height="200" style="border:1px solid #000000;"></canvas>
    
    <input type="button" id="clear" class="Button" value="Clear" onclick="Clear(canvas, canvas2)"/>

    <p id="prediction"></p>
    
    <script>
        tf.setBackend('cpu');
        var model = new Object;
        model.prob = new Array(10).fill(0);
        model.pred = null;
        (async () => {
            model.model = await tf.loadLayersModel('https://raw.githubusercontent.com/Hyuto/Hyuto.github.io/master/Content/Digit-Recognizer/model/model.json');
            model.model.summary()
        })();
        
        function run(model){
            const canvas = document.getElementById("myCanvas");
            const img = preprocess(canvas);
            const out = model.predict(img);
            model.prob = out.arraySync()[0];
            model.pred = out.argMax(1).arraySync()[0];
            document.getElementById("prediction").innerHTML = "Prediction : " + model.pred
        }

        function Clear(canvas, canvas2){
            canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
            canvas2.getContext("2d").clearRect(0, 0, canvas2.width, canvas2.height);
            document.getElementById("prediction").innerHTML = null;
        }

        //Base canvas and dimensions
        var canvas = document.getElementById("myCanvas");
        var canvas2 = document.getElementById("image");

        canvas.width = window.screen.width * 0.2;
        canvas.height = canvas.width;
        canvas2.width = window.screen.width * 0.2;
        canvas2.height = canvas2.width;

        var ctx = canvas.getContext("2d");
        var ctx2 = canvas2.getContext("2d");

        //Drawing variables
        var lastPosition = null;
        var drawing = false;

        //Drawing functionality
        function startDraw() {
            drawing = true;
        }
        
        function stopDraw() {
            drawing = false;
            lastPosition = null;
            run(model.model);
        }

        function mouseMove(evt) {
            var pos = {
                x: evt.offsetX,
                y: evt.offsetY
                };
            if (lastPosition !== null && drawing === true) {
                ctx.beginPath();
                ctx.moveTo(lastPosition.x, lastPosition.y);
                ctx.lineTo(pos.x, pos.y);
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';
                ctx.lineWidth = 15;
                ctx.closePath();
                ctx.stroke();
            }
            lastPosition = pos;
        }

        canvas.onmousedown = startDraw;
        canvas.onmouseup = stopDraw;
        canvas.onmouseleave = stopDraw;
        canvas.onmousemove = mouseMove;

        canvas.addEventListener("touchstart", function (e) {
            mousePos = getTouchPos(canvas, e);
            var touch = e.touches[0];
            var mouseEvent = new MouseEvent("mousedown", {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }, false);

        canvas.addEventListener("touchend", function (e) {
            var mouseEvent = new MouseEvent("mouseup", {});
            canvas.dispatchEvent(mouseEvent);
        }, false);

        canvas.addEventListener("touchmove", function (e) {
            var touch = e.touches[0];
            var mouseEvent = new MouseEvent("mousemove", {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }, false);
        
        function getTouchPos(canvasDom, touchEvent) {
            var rect = canvasDom.getBoundingClientRect();
            return {
                x: touchEvent.touches[0].clientX - rect.left,
                y: touchEvent.touches[0].clientY - rect.top
            };
        }
    </script>
</body>
</html>