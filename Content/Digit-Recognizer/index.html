<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="data.js"></script>
    <title>Digit Recognizer</title>
</head>
<body>
    <canvas id="myCanvas" width="200" height="200" style="border:1px solid #000000;"></canvas>
    <canvas id="image" width="200" height="200" style="border:1px solid #000000;"></canvas>
    
    <input type="button" id="clear" class="Button" value="Clear" onclick="Clear(canvas, canvas2)"/>

    <p id="prediction"></p>
    
    <script>
        var window = new Object;
        window.prob = new Array(10).fill(0);
        window.pred = null;

        (async () => {
            window.model = await tf.loadLayersModel('https://raw.githubusercontent.com/Hyuto/Hyuto.github.io/master/Content/Digit-Recognizer/model/model.json');
            window.model.summary()
        })();
        
        function run(model){
            const canvas = document.getElementById("myCanvas");
            const img = preprocess(canvas);
            const out = model.predict(img);
            window.prob = out.arraySync()[0];
            window.pred = out.argMax(1).arraySync()[0];
            document.getElementById("prediction").innerHTML = "Prediction : " + window.pred
        }

        function Clear(canvas, canvas2){
            canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
            canvas2.getContext("2d").clearRect(0, 0, canvas2.width, canvas2.height);
            document.getElementById("prediction").innerHTML = null;
        }

        //Base canvas and dimensions
        var canvas = document.getElementById("myCanvas");
        var canvas2 = document.getElementById("image");
        var ctx = canvas.getContext("2d");
        var ctx2 = canvas2.getContext("2d");

        //Drawing variables
        var lastPosition = null;
        var drawing = false;

        //Drawing functionality
        function startDraw() {
            drawing = true;
        }
        
        function stopDraw() {
            drawing = false;
        }

        function mouseMove(evt) {
            var pos = {
                x: evt.offsetX,
                y: evt.offsetY
                };
            if (lastPosition !== null && drawing === true) {
                ctx.beginPath();
                ctx.moveTo(lastPosition.x, lastPosition.y);
                ctx.lineTo(pos.x, pos.y);
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';
                ctx.lineWidth = 20;
                ctx.closePath();
                ctx.stroke();

                run(window.model);
            }
            lastPosition = pos;
        }

        canvas.onmousedown = startDraw;
        canvas.onmouseup = stopDraw;
        canvas.onmouseleave = stopDraw;
        canvas.onmousemove = mouseMove;

        canvas.ontouchstart = startDraw;
        canvas.ontouchmove = mouseMove;
        canvas.ontouchend = stopDraw;
        
    </script>
</body>
</html>